<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analisis Mendalam: Arsitektur IoT Greenhouse</title>
    <style>
      :root {
        --primary-color: #0d47a1; /* Biru Tua */
        --secondary-color: #1976d2; /* Biru Sedang */
        --accent-color: #ffb300; /* Kuning/Orange */
        --bg-color: #f5f7fa;
        --text-color: #333;
        --card-bg: #ffffff;
        --border-color: #e0e0e0;
        --success-color: #2e7d32;
        --error-color: #c62828;
        --terminal-bg: #1e1e1e;
        --terminal-text: #d4d4d4;
        --terminal-cmd: #9cdcfe;
        --terminal-sys: #ce9178;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji",
          "Segoe UI Symbol";
        line-height: 1.7;
        margin: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        color: white;
        padding: 2rem 1rem;
        text-align: center;
        border-bottom-left-radius: 15px;
        border-bottom-right-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      header h1 {
        margin: 0;
        font-size: 2.8rem;
      }
      header p {
        margin-top: 5px;
        font-size: 1.2rem;
        opacity: 0.9;
      }

      .section {
        background: var(--card-bg);
        margin: 25px 0;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.07);
        border-top: 4px solid var(--secondary-color);
      }

      h2 {
        color: var(--primary-color);
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 15px;
        font-size: 1.8rem;
      }
      h3 {
        color: var(--secondary-color);
        font-size: 1.4rem;
      }
      h4 {
        color: var(--primary-color);
        font-size: 1.2rem;
        margin-top: 25px;
      }

      .diagram-container {
        text-align: center;
        margin: 30px 0;
      }
      #system-diagram {
        width: 100%;
        max-width: 1000px;
        cursor: default;
      }
      #system-diagram .component {
        cursor: pointer;
        transition: all 0.3s ease;
      }
      #system-diagram .component:hover {
        transform: translateY(-5px);
        filter: drop-shadow(0 5px 8px rgba(0, 121, 107, 0.4));
      }
      #system-diagram .label {
        font-size: 10px;
        font-family: inherit;
        font-weight: bold;
      }
      #system-diagram .sub-label {
        font-size: 8px;
        font-family: inherit;
        fill: #555;
      }

      .info-panel {
        margin-top: 20px;
        padding: 20px;
        background-color: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 8px;
        min-height: 100px;
      }
      .info-panel h3 {
        margin-top: 0;
        color: #0d47a1;
      }

      .tabs {
        display: flex;
        border-bottom: 2px solid var(--border-color);
      }
      .tab-button {
        padding: 12px 25px;
        cursor: pointer;
        border: none;
        background: none;
        font-size: 1.1rem;
        font-weight: 600;
        color: #555;
        position: relative;
      }
      .tab-button.active {
        color: var(--primary-color);
      }
      .tab-button.active::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 3px;
        background: var(--primary-color);
        border-radius: 3px;
      }

      .tab-content {
        display: none;
        padding: 25px 5px;
      }
      .tab-content.active {
        display: block;
        animation: fadeIn 0.5s;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .feature-list {
        list-style: none;
        padding-left: 0;
      }
      .feature-list li {
        padding-left: 30px;
        position: relative;
        margin-bottom: 15px;
      }
      .feature-list li::before {
        content: "✓";
        color: var(--success-color);
        position: absolute;
        left: 0;
        font-size: 1.2rem;
        font-weight: bold;
      }

      .flow-simulation {
        margin-top: 20px;
        padding: 20px;
        border: 2px dashed var(--border-color);
        border-radius: 8px;
      }
      .flow-item {
        display: flex;
        align-items: center;
        margin: 15px 0;
        opacity: 0;
        transform: translateX(-20px);
        transition: opacity 0.5s ease, transform 0.5s ease;
      }
      .flow-item.visible {
        opacity: 1;
        transform: translateX(0);
      }
      .flow-icon {
        font-size: 2.2rem;
        margin-right: 18px;
        width: 45px;
        text-align: center;
      }

      .simulation-controls {
        margin-top: 15px;
      }
      .sim-button {
        background: var(--accent-color);
        color: var(--text-color);
        border: none;
        padding: 12px 22px;
        font-size: 1rem;
        font-weight: bold;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .sim-button:hover {
        background-color: #ffc400;
      }
      .sim-button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      .terminal-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }
      .terminal-wrapper {
        background: var(--terminal-bg);
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }
      .terminal-header {
        color: var(--terminal-text);
        font-weight: bold;
        margin-bottom: 10px;
      }
      .terminal-screen {
        height: 300px;
        overflow-y: auto;
        background: var(--terminal-bg);
        color: var(--terminal-text);
        font-family: "SFMono-Regular", Consolas, "Courier New", monospace;
        font-size: 0.9em;
        white-space: pre-wrap;
        border: 1px solid #444;
        padding: 10px;
      }
      .terminal-screen p {
        margin: 0 0 5px 0;
      }
      .terminal-screen .cmd {
        color: var(--terminal-cmd);
      }
      .terminal-screen .sys {
        color: var(--terminal-sys);
      }
      .terminal-screen .prompt {
        color: var(--terminal-cmd);
      }

      .portal-simulation-grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 30px;
        align-items: center;
      }
      .phone-mockup {
        width: 250px;
        height: 450px;
        background: #333;
        border-radius: 30px;
        padding: 15px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        margin: 0 auto;
      }
      .phone-screen {
        background: white;
        flex-grow: 1;
        border-radius: 15px;
        padding: 20px;
        font-size: 0.8rem;
        color: #333;
        overflow-y: auto;
      }
      .browser-mockup {
        border: 1px solid #ccc;
        border-radius: 8px;
        background: #fff;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      }
      .browser-header {
        padding: 8px;
        background: #e0e0e0;
        border-bottom: 1px solid #ccc;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
      }
      .browser-content {
        padding: 20px;
      }
      .portal-form input {
        width: 90%;
        padding: 8px;
        margin-bottom: 10px;
      }
      .portal-form button {
        width: 100%;
        padding: 10px;
        background: var(--success-color);
        color: white;
        border: none;
        border-radius: 5px;
      }
      .progress-bar {
        width: 100%;
        background: #e0e0e0;
        border-radius: 5px;
        overflow: hidden;
        height: 25px;
        margin-top: 15px;
      }
      .progress-bar-fill {
        width: 0%;
        height: 100%;
        background: var(--success-color);
        transition: width 2s ease-in-out;
        text-align: center;
        color: white;
        line-height: 25px;
      }

      @media (max-width: 900px) {
        .terminal-container,
        .portal-simulation-grid {
          grid-template-columns: 1fr;
        }
        .phone-mockup {
          margin-top: 20px;
        }
      }

      code {
        background-color: #e0e0e0;
        padding: 3px 7px;
        border-radius: 4px;
        font-family: "SFMono-Regular", Consolas, "Courier New", monospace;
      }

      footer {
        text-align: center;
        margin-top: 40px;
        padding: 25px;
        color: #777;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Analisis Mendalam: Arsitektur IoT Greenhouse</h1>
      <p>Studi Kasus Peran Simbiotik antara Sensor Node dan Gateway</p>
    </header>

    <div class="container">
      <!-- Sections: Diagram, Peran & Fitur (Tidak Berubah) -->
      <div class="section">
        <h2>Diagram Arsitektur Sistem</h2>
        <p>
          Diagram ini mengilustrasikan komponen utama dan alur komunikasi dalam
          sistem. Klik pada setiap komponen untuk mendapatkan penjelasan detail.
        </p>
        <div class="diagram-container">
          <svg id="system-diagram" viewBox="0 0 450 220">
            <defs>
              <marker
                id="arrow"
                viewBox="0 0 10 10"
                refX="5"
                refY="5"
                markerWidth="6"
                markerHeight="6"
                orient="auto-start-reverse"
              >
                <path d="M 0 0 L 10 5 L 0 10 z" fill="#333" />
              </marker>
            </defs>
            <path
              d="M 105 110 C 130 110, 130 110, 155 110"
              stroke="#333"
              stroke-width="1.5"
              stroke-dasharray="5,5"
              marker-end="url(#arrow)"
            />
            <path
              d="M 295 110 C 320 110, 320 110, 345 110"
              stroke="#333"
              stroke-width="2"
              marker-end="url(#arrow)"
            />
            <path
              d="M 295 120 C 320 120, 320 120, 345 120"
              stroke="#333"
              stroke-width="2"
              marker-start="url(#arrow)"
            />
            <path
              d="M 225 85 C 225 60, 225 60, 225 35"
              stroke="#c62828"
              stroke-width="2"
              stroke-dasharray="3,3"
              marker-end="url(#arrow)"
            />
            <text x="115" y="100" class="sub-label">Data Sensor (WiFi)</text>
            <text x="300" y="100" class="sub-label">
              Komunikasi API (HTTPS)
            </text>
            <text x="230" y="60" class="sub-label">Sinyal Kontrol</text>
            <g class="component" data-info="node">
              <rect
                x="20"
                y="80"
                width="85"
                height="60"
                fill="#26a69a"
                rx="8"
              />
              <text x="62.5" y="110" class="label" fill="white">SENSOR</text>
              <text x="62.5" y="122" class="label" fill="white">NODE</text>
              <text x="35" y="98" font-size="12px">🌡️</text>
            </g>
            <g class="component" data-info="gateway">
              <rect
                x="155"
                y="75"
                width="140"
                height="70"
                fill="#00796b"
                rx="8"
              />
              <text x="225" y="110" class="label" fill="white">GATEWAY</text>
              <text x="170" y="95" font-size="12px">🧠</text>
              <text x="170" y="130" font-size="12px">📶 GPRS</text>
            </g>
            <g class="component" data-info="cloud">
              <path
                d="M 350 115 C 340 95, 370 85, 380 95 C 400 95, 410 110, 400 125 C 400 140, 370 145, 360 135 C 345 135, 340 125, 350 115"
                fill="#1976d2"
              />
              <text x="380" y="118" class="label" fill="white">
                CLOUD / API
              </text>
            </g>
            <g class="component" data-info="actuator">
              <rect
                x="200"
                y="10"
                width="50"
                height="25"
                fill="#ffb300"
                rx="5"
              />
              <text x="225" y="27" class="label" fill="#333">AKTUATOR</text>
            </g>
          </svg>
        </div>
        <div class="info-panel" id="info-panel">
          <h3>Selamat Datang!</h3>
          <p>
            Ini adalah visualisasi arsitektur sistem IoT Greenhouse kita.
            Silakan klik pada salah satu komponen di atas untuk melihat
            deskripsi detail perannya.
          </p>
        </div>
      </div>
      <div class="section">
        <h2>Peran dan Fitur Unggulan</h2>
        <div class="tabs">
          <button
            class="tab-button active"
            onclick="openTab(event, 'node-tab')"
          >
            Sensor Node
          </button>
          <button class="tab-button" onclick="openTab(event, 'gateway-tab')">
            Gateway
          </button>
        </div>
        <div id="node-tab" class="tab-content active">
          <h3>Sensor Node: Pengumpul Data yang Tangguh dan Andal</h3>
          <p>
            Sensor Node adalah unit pekerja keras di lapangan. Perannya sangat
            terspesialisasi: mengukur kondisi lingkungan dengan akurat dan
            memastikan setiap data sampai ke server, apapun yang terjadi. Ia
            adalah perwujudan dari filosofi "Integritas Data Di Atas Segalanya".
          </p>
          <h4>Fitur Unggulan:</h4>
          <ul class="feature-list">
            <li>
              <strong>Caching dengan <em>Binary Ring Buffer</em>:</strong> Fitur
              paling kritis. Jika koneksi WiFi putus, data tidak hilang. Data
              akan disimpan dalam format biner yang efisien di satu file tunggal
              pada memori flash. Mekanisme ini meminimalkan "keausan" pada
              memori dan sangat cepat. Ketika koneksi pulih, antrian data akan
              dikirim secara otomatis.
            </li>
            <li>
              <strong>Desain <em>Headless</em> dan Minimalis:</strong> Tidak ada
              layar, tidak ada tombol. Ini membuatnya murah untuk diproduksi
              massal, hemat daya, dan memiliki lebih sedikit titik kegagalan.
              Semua diagnostik dan konfigurasi dilakukan dari jarak jauh melalui
              terminal WebSerial.
            </li>
            <li>
              <strong>Pemulihan Sensor Otomatis:</strong> Jika sensor I2C macet
              (masalah umum di lapangan), Node akan mencoba memulihkan bus I2C
              secara otomatis dengan "menggoyangkan" jalur clock, sebelum
              mencoba menginisialisasi ulang sensor.
            </li>
            <li>
              <strong>Kalibrasi <em>Compile-Time</em>:</strong> Setiap node
              fisik dapat memiliki nilai kalibrasi sensor yang unik yang
              ditentukan saat kompilasi berdasarkan <code>NODE_ID</code>. Ini
              memungkinkan satu basis kode untuk semua node, namun dengan
              kalibrasi yang presisi.
            </li>
          </ul>
        </div>
        <div id="gateway-tab" class="tab-content">
          <h3>Gateway: Pusat Komando yang Selalu Terhubung</h3>
          <p>
            Gateway adalah otak sekaligus tangan dari sistem. Ia tidak hanya
            meneruskan data, tetapi secara aktif mengambil keputusan dan
            bertindak. Desainnya berpusat pada filosofi "Ketersediaan dan
            Keamanan Operasional Maksimal".
          </p>
          <h4>Fitur Unggulan:</h4>
          <ul class="feature-list">
            <li>
              <strong><em>Dual-Network Redundancy (WiFi + GPRS)</em>:</strong>
              Gateway selalu berusaha terhubung. Ia memprioritaskan WiFi, tetapi
              jika gagal, modem seluler SIM800L akan mengambil alih secara
              otomatis. Ia bahkan akan secara berkala memeriksa apakah WiFi
              sudah pulih untuk beralih kembali.
            </li>
            <li>
              <strong>Logika <em>Failsafe</em>:</strong> Jika Gateway kehilangan
              koneksi ke server API untuk waktu yang lama, ia akan masuk ke mode
              aman, mematikan semua relay untuk mencegah kerusakan pada tanaman.
            </li>
            <li>
              <strong><em>Persistent State</em> dengan NVS:</strong> Perintah
              manual (override) dari pengguna, seperti "paksa nyalakan kipas",
              disimpan di Non-Volatile Storage (NVS). Artinya, jika Gateway mati
              listrik dan hidup lagi, perintah override tersebut akan tetap
              diingat dan dilanjutkan.
            </li>
            <li>
              <strong>Manajemen Waktu dengan Hardware RTC (DS3231):</strong>
              Gateway membutuhkan waktu yang akurat untuk logging, bahkan saat
              offline. Modul RTC dengan baterai cadangan memastikan timestamp
              selalu benar.
            </li>
          </ul>
        </div>
      </div>

      <!-- Bagian Baru: Antarmuka Konfigurasi & Manajemen -->
      <div class="section">
        <h2>Antarmuka Konfigurasi & Manajemen</h2>
        <p>
          Gateway, sebagai pusat kendali, dilengkapi dengan antarmuka web yang
          kuat untuk memudahkan penyiapan awal dan pemeliharaan firmware. Mari
          kita simulasikan cara kerjanya.
        </p>

        <h4>1. Captive Portal untuk Konfigurasi WiFi Awal</h4>
        <div class="portal-simulation-grid">
          <div>
            <p>
              Ketika Gateway dinyalakan untuk pertama kali (atau gagal terhubung
              ke WiFi yang tersimpan), ia akan membuat Access Point (AP)
              sendiri. Simulasi di samping menunjukkan pengalaman pengguna saat
              menghubungkan perangkat baru.
            </p>
            <strong>Cara Kerja di Balik Layar:</strong>
            <ol>
              <li>
                <strong>Mode AP:</strong> Gateway membuat jaringan WiFi, misal
                <code>Gateway-Config-1</code>.
              </li>
              <li>
                <strong>DNS Hijacking:</strong> Saat ponsel Anda terhubung dan
                mencoba mengakses internet, Gateway "membajak" permintaan
                tersebut dan mengarahkannya ke halaman konfigurasinya sendiri.
                Inilah mengapa halaman login muncul secara otomatis.
              </li>
              <li>
                <strong>Penyimpanan Kredensial:</strong> Kredensial yang Anda
                masukkan disimpan dengan aman di memori NVS (Non-Volatile
                Storage) ESP32.
              </li>
              <li>
                <strong>Reboot:</strong> Perangkat kemudian reboot dan
                menggunakan kredensial yang baru disimpan untuk terhubung ke
                jaringan WiFi Anda.
              </li>
            </ol>
            <div class="simulation-controls">
              <button class="sim-button" id="start-captive-sim">
                Jalankan Simulasi Captive Portal
              </button>
            </div>
          </div>
          <div class="phone-mockup">
            <div class="phone-screen" id="captive-portal-screen">
              <p>Klik tombol simulasi untuk memulai...</p>
            </div>
          </div>
        </div>

        <h4 style="margin-top: 40px">
          2. Portal Update Firmware (OTA) via Web
        </h4>
        <div class="portal-simulation-grid">
          <div>
            <p>
              Untuk mempermudah pembaruan firmware tanpa perlu koneksi fisik,
              Gateway menyediakan halaman web khusus di alamat IP-nya (misal:
              <code>http://192.168.1.100/update</code>).
            </p>
            <strong>Cara Kerja di Balik Layar:</strong>
            <ol>
              <li>
                <strong>Otentikasi:</strong> Halaman ini dilindungi kata sandi
                untuk mencegah akses tidak sah.
              </li>
              <li>
                <strong>Upload Bertahap:</strong> Saat Anda mengunggah file
                <code>.bin</code>, file tersebut tidak dimuat ke RAM (yang
                terbatas), melainkan dikirim dalam potongan-potongan (chunks).
              </li>
              <li>
                <strong>Penulisan ke Partisi OTA:</strong> ESP32 memiliki dua
                partisi untuk firmware. Pustaka <code>Update</code> akan menulis
                firmware baru ke partisi yang sedang tidak aktif, tanpa
                mengganggu firmware yang sedang berjalan.
              </li>
              <li>
                <strong>Aktivasi & Reboot:</strong> Setelah upload 100% dan
                terverifikasi, bootloader diinstruksikan untuk menggunakan
                partisi yang baru di-update pada saat reboot berikutnya.
                Perangkat kemudian reboot dengan firmware baru.
              </li>
            </ol>
            <div class="simulation-controls">
              <button class="sim-button" id="start-ota-sim">
                Jalankan Simulasi Update OTA
              </button>
            </div>
          </div>
          <div class="browser-mockup">
            <div class="browser-header"></div>
            <div class="browser-content" id="ota-portal-content">
              <p>Klik tombol simulasi untuk memulai...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Section Simulasi Terminal (Tidak Berubah) -->
      <div class="section">
        <h2>Fitur Diagnostik: Terminal WebSerial</h2>
        <p>
          Kedua perangkat dilengkapi dengan terminal berbasis WebSocket untuk
          diagnostik dan administrasi jarak jauh. Namun, fungsionalitasnya
          sangat berbeda, disesuaikan dengan peran masing-masing perangkat.
        </p>
        <div class="terminal-container">
          <div class="terminal-wrapper">
            <h3>Terminal Sensor Node</h3>
            <p>
              Fokus pada diagnostik mendalam, konfigurasi, dan debugging fitur
              inti seperti caching dan sensor.
            </p>
            <div class="terminal-screen" id="node-terminal-screen">
              <p class="sys">[SYSTEM] Greenhouse Node Terminal Connected.</p>
              <p class="sys">
                [SYSTEM] Please use 'login &lt;password&gt;' to access admin
                commands.
              </p>
            </div>
            <div class="simulation-controls">
              <button class="sim-button" id="start-node-terminal-sim">
                Jalankan Simulasi Terminal Node
              </button>
            </div>
          </div>
          <div class="terminal-wrapper">
            <h3>Terminal Gateway</h3>
            <p>
              Fokus pada pemantauan status tingkat tinggi dan tindakan cepat. UI
              lebih ramah pengguna dengan pesan berwarna.
            </p>
            <div class="terminal-screen" id="gateway-terminal-screen">
              <p class="sys">[System] Connected to ESP32!</p>
            </div>
            <div class="simulation-controls">
              <button class="sim-button" id="start-gateway-terminal-sim">
                Jalankan Simulasi Terminal Gateway
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Section Simulasi Alur Kerja (Tidak Berubah) -->
      <div class="section">
        <h2>Simulasi Alur Kerja Sistem</h2>
        <div class="tabs">
          <button
            class="tab-button active"
            onclick="openSimTab(event, 'node-sim-tab')"
          >
            Simulasi Sensor Node
          </button>
          <button
            class="tab-button"
            onclick="openSimTab(event, 'gateway-sim-tab')"
          >
            Simulasi Gateway
          </button>
        </div>
        <div id="node-sim-tab" class="tab-content active">
          <h4>Alur Kerja Sensor Node (Fokus pada Caching)</h4>
          <p>
            Simulasi ini menunjukkan bagaimana Sensor Node menangani pengiriman
            data dan apa yang terjadi saat koneksi terputus.
          </p>
          <div class="flow-simulation" id="node-flow-container"></div>
          <div class="simulation-controls">
            <button class="sim-button" id="start-node-simulation">
              Jalankan Simulasi Node
            </button>
          </div>
        </div>
        <div id="gateway-sim-tab" class="tab-content">
          <h4>Alur Kerja Gateway (Fokus pada Kontrol & Redundansi)</h4>
          <p>
            Simulasi ini menunjukkan bagaimana Gateway membuat keputusan,
            mengontrol relay, dan menangani kegagalan jaringan WiFi.
          </p>
          <div class="flow-simulation" id="gateway-flow-container"></div>
          <div class="simulation-controls">
            <button class="sim-button" id="start-gateway-simulation">
              Jalankan Simulasi Gateway
            </button>
          </div>
        </div>
      </div>

      <!-- Section Tabel Perbandingan (Tidak Berubah) -->
      <div class="section">
        <h2>Tabel Perbandingan Rangkuman</h2>
        <table class="comparison-table">
          <thead>
            <tr>
              <th>Fitur</th>
              <th>Sensor Node</th>
              <th>Gateway</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Peran Utama</td>
              <td>Produsen Data (Mengukur & Mengirim)</td>
              <td>Pengendali (Berpikir & Bertindak)</td>
            </tr>
            <tr>
              <td>Konektivitas</td>
              <td>WiFi Saja</td>
              <td><strong>WiFi + GPRS (Seluler)</strong> sebagai cadangan</td>
            </tr>
            <tr>
              <td>Strategi Saat Offline</td>
              <td>
                <strong>Menyimpan data di Cache</strong> untuk dikirim nanti
              </td>
              <td>Masuk ke <strong>Mode Aman (Failsafe)</strong></td>
            </tr>
            <tr>
              <td>Kontrol Perangkat Keras</td>
              <td>Tidak ada (hanya membaca sensor)</td>
              <td>Mengontrol 4 Relay (kipas, dll.)</td>
            </tr>
            <tr>
              <td>Antarmuka Lokal</td>
              <td>Tidak ada (Headless)</td>
              <td><strong>Layar LCD 20x4</strong> untuk status real-time</td>
            </tr>
            <tr>
              <td>Manajemen Waktu</td>
              <td>Sinkronisasi NTP (saat online)</td>
              <td><strong>Modul RTC Hardware</strong> (selalu akurat) + NTP</td>
            </tr>
            <tr>
              <td>Persistensi Status</td>
              <td>Hanya Konfigurasi</td>
              <td><strong>Konfigurasi & Override Relay (NVS)</strong></td>
            </tr>
            <tr>
              <td>Fitur Unggulan</td>
              <td>Caching data yang sangat andal</td>
              <td>Redundansi jaringan dan logika failsafe</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <footer><p>Dibuat untuk edukasi internal. &copy; 2024</p></footer>

    <script>
      // --- Tab Logic ---
      function openTab(evt, tabName) {
        let i, tabcontent, tabbuttons;
        tabcontent =
          evt.currentTarget.parentElement.nextElementSibling.parentElement.querySelectorAll(
            ".tab-content"
          );
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }
        tabbuttons =
          evt.currentTarget.parentElement.querySelectorAll(".tab-button");
        for (i = 0; i < tabbuttons.length; i++) {
          tabbuttons[i].classList.remove("active");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.classList.add("active");
      }
      function openSimTab(evt, tabName) {
        let tabContents = document.querySelectorAll(
          "#node-sim-tab, #gateway-sim-tab"
        );
        tabContents.forEach((tc) => tc.classList.remove("active"));
        document.getElementById(tabName).classList.add("active");
        let tabButtons = document.querySelectorAll(".tabs .tab-button");
        tabButtons.forEach((tb) => tb.classList.remove("active"));
        evt.currentTarget.classList.add("active");
      }
      document.querySelectorAll(".tabs .tab-button")[0].click();
      document.querySelectorAll(".tabs .tab-button")[2].click();

      // --- Interactive Diagram Logic ---
      const componentInfo = {
        node: {
          title: "Sensor Node",
          text: "Perangkat ini bertugas mengukur suhu, kelembaban, dan cahaya. Ia memiliki fitur cache canggih untuk menyimpan data jika koneksi WiFi terputus, memastikan tidak ada data yang hilang.",
        },
        gateway: {
          title: "Gateway",
          text: "Ini adalah otak dari sistem. Ia menerima data, membuat keputusan, dan mengontrol aktuator. Memiliki koneksi ganda (WiFi + Seluler) untuk keandalan maksimal dan layar LCD untuk pemantauan.",
        },
        cloud: {
          title: "Cloud / Server API",
          text: "Server pusat yang menerima dan menyimpan semua data dari Sensor Node. Gateway juga mengambil data ambang batas dan status override manual dari sini.",
        },
        actuator: {
          title: "Aktuator",
          text: "Ini adalah perangkat fisik di greenhouse, seperti kipas exhaust, blower, atau dehumidifier. Gateway mengontrol perangkat ini melalui Relay.",
        },
      };
      document.querySelectorAll("#system-diagram .component").forEach((c) => {
        c.addEventListener("click", () => {
          document.getElementById(
            "info-panel"
          ).innerHTML = `<h3>${info.title}</h3><p>${info.text}</p>`;
        });
      });

      // --- General Simulation Runner ---
      function runSimulation(containerId, steps, button, isTerminal = false) {
        button.disabled = true;
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        let delay = 0;
        steps.forEach((step, index) => {
          setTimeout(() => {
            const el = document.createElement(isTerminal ? "p" : "div");
            if (isTerminal) {
              el.className = step.class || "";
              el.innerHTML = step.text;
            } else {
              el.className = "flow-item";
              el.innerHTML = step.icon
                ? `<div class="flow-icon">${step.icon}</div><div>${step.text}</div>`
                : step.text;
            }
            container.appendChild(el);
            if (!isTerminal) {
              void el.offsetWidth;
              el.classList.add("visible");
            }
            container.scrollTop = container.scrollHeight;
            if (index === steps.length - 1) {
              button.disabled = false;
            }
          }, delay);
          delay += step.delay || 1200;
        });
      }

      // --- Simulation Steps Data ---
      const nodeSimSteps = [
        { icon: "🌡️", text: "Sensor Node membaca data suhu dan kelembaban." },
        { icon: "📝", text: "Data diformat menjadi sebuah paket JSON." },
        { icon: "📶", text: "Mencoba mengirim data via WiFi..." },
        {
          icon: "✅",
          text: "Koneksi WiFi berhasil! Data dikirim ke Server Cloud.",
        },
        { icon: "---", text: "--- Siklus berikutnya ---", delay: 1500 },
        { icon: "🌡️", text: "Sensor Node membaca data baru." },
        {
          icon: "❌",
          text: "<strong>Koneksi WiFi terputus!</strong> Pengiriman gagal.",
        },
        {
          icon: "📦",
          text: "<strong>Fitur Caching Aktif!</strong> Data disimpan ke dalam <em>Binary Ring Buffer</em> di memori internal Node.",
        },
        {
          icon: "🔄",
          text: "Node terus mencoba menyambung kembali ke WiFi sambil tetap menyimpan data baru ke cache...",
        },
        { icon: "✅", text: "<strong>Koneksi WiFi pulih!</strong>" },
        {
          icon: "📤",
          text: "Node mulai mengunggah semua data dari cache, dari yang terlama hingga terbaru.",
        },
        {
          icon: "💯",
          text: "Semua data berhasil terkirim. <strong>Tidak ada data yang hilang!</strong> Sistem kembali normal.",
        },
      ];
      const gatewaySimSteps = [
        {
          icon: "📡",
          text: "Gateway boot up, mencoba koneksi ke WiFi prioritas...",
        },
        {
          icon: "❌",
          text: "<strong>Koneksi WiFi gagal!</strong> Router mungkin mati.",
        },
        {
          icon: "📲",
          text: "<strong>Fitur Redundansi Aktif!</strong> Beralih ke koneksi cadangan GPRS (seluler)...",
        },
        { icon: "✅", text: "Koneksi GPRS berhasil. Gateway sekarang online." },
        {
          icon: "📥",
          text: "Gateway mengambil data ambang batas (Thresholds) dari Cloud API. Misal: Suhu Maks = 30°C.",
        },
        {
          icon: "📥",
          text: "Gateway mengambil data sensor terakhir dari Cloud API. Misal: Suhu saat ini = 32°C.",
        },
        {
          icon: "🧠",
          text: "<strong>Logika Kontrol Bekerja:</strong> Membandingkan data. <code>(32°C > 30°C)</code> bernilai BENAR.",
        },
        {
          icon: "💡",
          text: "<strong>Keputusan Dibuat:</strong> Perlu menyalakan kipas pendingin (Aktuator).",
        },
        { icon: "⚡", text: "Gateway mengirim sinyal listrik ke Relay Kipas." },
        {
          icon: "💨",
          text: "Relay menyala, Aktuator (Kipas) berputar, suhu mulai turun.",
        },
        {
          icon: "📤",
          text: "Gateway melaporkan status barunya (Relay Kipas: ON) ke Cloud API.",
        },
      ];
      const nodeTerminalSimSteps = [
        {
          text: '<span class="prompt">> </span><span class="cmd">login rahasia123</span>',
          delay: 1500,
        },
        {
          text: "[AUTH] Login successful. Admin commands are now enabled for this session.",
        },
        {
          text: '<span class="prompt">> </span><span class="cmd">cache_status</span>',
          delay: 2000,
        },
        { text: "--- Cache Status (Binary Ring Buffer) ---" },
        { text: "Queued Data: 1450 bytes" },
        { text: "Head Pointer (next write): 8730" },
        { text: "Tail Pointer (next read): 7280" },
        {
          text: '<span class="prompt">> </span><span class="cmd">read_sensors</span>',
          delay: 2500,
        },
        { text: "--- Real-time Sensor Reading ---" },
        { text: "SHT Status: OK" },
        { text: "  Temperature (calibrated): 28.5 C" },
        { text: "  Humidity (calibrated): 75.2 %" },
        { text: "BH1750 Status: OK" },
        { text: "  Light (calibrated): 8540 Lux" },
      ];
      const gatewayTerminalSimSteps = [
        { class: "sys", text: "[System] Connected to ESP32!" },
        { class: "sys", text: "[RX] --- System Status ---", delay: 1500 },
        { class: "sys", text: "[RX] Firmware: 3.2.0, GH_ID: 1 (GREENHOUSE 1)" },
        { class: "sys", text: "[RX] GPRS Connected: Yes, Signal: 25" },
        { class: "sys", text: "[RX] Time: 2024-05-21 14:30:15" },
        { class: "sys", text: "[RX] Relays (Exh,Deh,Blw): 1, 0, 1" },
        { class: "cmd", text: "[TX] resetwifi medini123", delay: 2500 },
        {
          text: '<span class="sys">[RX]</span> Clearing WiFi credentials and rebooting...',
        },
        {
          class: "sys",
          text: "[System] Connection lost. Retrying...",
          delay: 1500,
        },
      ];

      // --- Portal Simulation ---
      const captiveScreen = document.getElementById("captive-portal-screen");
      const otaScreen = document.getElementById("ota-portal-content");
      function runCaptivePortalSimulation(button) {
        button.disabled = true;
        let step = 0;
        const steps = [
          () => {
            captiveScreen.innerHTML = `<b>Pengaturan WiFi</b><hr><p>Pilih jaringan:</p><p>&#9921; <b>Gateway-Config-1</b> (Terhubung)</p><p>&#9921; Tetangga_WiFi</p><p><i>Menunggu login jaringan...</i></p>`;
          },
          () => {
            captiveScreen.innerHTML = `<div class="portal-form"><h3>Konfigurasi Gateway</h3><p>Masukkan kredensial WiFi Anda.</p><label>WiFi SSID:</label><input type="text" value="GH Atas"><label>Password:</label><input type="password" value="•••••••••"><button>Simpan & Hubungkan</button></div>`;
          },
          () => {
            captiveScreen.innerHTML = `<div style="text-align:center;"><h3>Menghubungkan...</h3><p>Mencoba terhubung ke 'GH Atas'. Mohon tunggu...</p></div>`;
          },
          () => {
            captiveScreen.innerHTML = `<div style="text-align:center; color: var(--success-color);"><h3>Berhasil! ✅</h3><p>Gateway terhubung. Perangkat akan reboot dalam 3 detik...</p></div>`;
          },
          () => {
            button.disabled = false;
            captiveScreen.innerHTML = `<p>Klik tombol simulasi untuk memulai...</p>`;
          },
        ];

        function nextStep() {
          if (step < steps.length) {
            steps[step]();
            step++;
            setTimeout(nextStep, 2500);
          }
        }
        nextStep();
      }

      function runOtaSimulation(button) {
        button.disabled = true;
        otaScreen.innerHTML = `<h3>Firmware Web Updater</h3><p>Pilih file <code>.bin</code> untuk diunggah.</p><input type="text" readonly value="firmware-v3.2.1.bin" style="width: 70%"><button style="margin-left: 10px;">Upload</button><div class="progress-bar"><div id="ota-progress" class="progress-bar-fill"></div></div><p id="ota-status" style="text-align:center;"></p>`;

        setTimeout(() => {
          const progressBar = document.getElementById("ota-progress");
          const statusText = document.getElementById("ota-status");
          statusText.innerText = "Mengunggah...";
          progressBar.style.width = "100%";
          progressBar.innerText = "100%";

          setTimeout(() => {
            statusText.style.color = "var(--success-color)";
            statusText.innerText =
              "Update Berhasil! Perangkat sedang reboot...";
            setTimeout(() => {
              otaScreen.innerHTML = `<p>Klik tombol simulasi untuk memulai...</p>`;
              button.disabled = false;
            }, 3000);
          }, 2200);
        }, 500);
      }

      // --- Final Event Listeners ---
      document
        .getElementById("start-node-simulation")
        .addEventListener("click", (e) =>
          runSimulation("node-flow-container", nodeSimSteps, e.target)
        );
      document
        .getElementById("start-gateway-simulation")
        .addEventListener("click", (e) =>
          runSimulation("gateway-flow-container", gatewaySimSteps, e.target)
        );
      document
        .getElementById("start-node-terminal-sim")
        .addEventListener("click", (e) =>
          runSimulation(
            "node-terminal-screen",
            nodeTerminalSimSteps,
            e.target,
            true
          )
        );
      document
        .getElementById("start-gateway-terminal-sim")
        .addEventListener("click", (e) =>
          runSimulation(
            "gateway-terminal-screen",
            gatewayTerminalSimSteps,
            e.target,
            true
          )
        );
      document
        .getElementById("start-captive-sim")
        .addEventListener("click", (e) => runCaptivePortalSimulation(e.target));
      document
        .getElementById("start-ota-sim")
        .addEventListener("click", (e) => runOtaSimulation(e.target));
    </script>
  </body>
</html>
